---
steps:
- checkout: self

- template: ../tasks/UseDotNet.yml

- template: ../tasks/NuGetToolInstaller.yml

- template: ../tasks/NuGetCommand.yml
  parameters:
    Command: 'restore'
    solution: '$(Build.SourcesDirectory)\src\MIDebugEngine.sln'
    FeedsToUse: 'config'
    NugetConfigPath: '$(Build.SourcesDirectory)\src\.nuget\NuGet.config'

- template: ../tasks/MSBuild.yml
  parameters:
    solution: '$(Build.SourcesDirectory)\test\CppTests\CppTests.csproj'
    configuration: 'Release'
    msbuildArguments: /p:NuGetPath=$(NuGetExeToolPath) /p:NuGetPrerelease=false
    env: { 
        "SIGN_TYPE": "real" 
    } 

- template: ../tasks/SignVerify.yml
  parameters:
    TargetFolders: '$(Build.SourcesDirectory)\bin\DebugAdapterProtocolTests\Release\drop'

- template: ../steps/CopyAndPublishSymbols.yml
  parameters:
    SourceFolder: '$(Build.SourcesDirectory)\bin\DebugAdapterProtocolTests\Release\drop'
    OneESPT: true

- template: ../tasks/1ES/PublishPipelineArtifact.yml
  parameters:
    displayName: 'Publish Nupkgs'
    targetPath: '$(Build.SourcesDirectory)\bin\DebugAdapterProtocolTests\Release\drop'
    artifactName: 'nupkgs'
    OneESPT: true

- task: 1ES.PublishNuget@1
  displayName: 'NuGet push'
  inputs:
    packageParentPath: '$(Build.SourcesDirectory)\bin\DebugAdapterProtocolTests\Release\drop\'
    packagesToPush: '$(Build.SourcesDirectory)\bin\DebugAdapterProtocolTests\Release\drop\*.nupkg'
    publishVstsFeed: 'cf33e8db-bbb9-4205-82ee-e1cd159cce99'

# Retain the pipeline run for 2 years so we can compare future builds against it
- powershell: |
    $contentType = 'application/json';
    $headers = @{ Authorization = 'Bearer $(System.AccessToken)' };
    $rawRequest = @{ daysValid = 365 * 2; definitionId = $(System.DefinitionId); ownerId = 'User:$(Build.RequestedForId)'; protectPipeline = $false; runId = $(Build.BuildId) };
    $request = ConvertTo-Json @($rawRequest);
    Write-Host $request
    $uri = "$(System.CollectionUri)$(System.TeamProject)/_apis/build/retention/leases?api-version=6.0-preview.1";
    Invoke-RestMethod -uri $uri -method POST -Headers $headers -ContentType $contentType -Body $request;
  displayName: Retain build

- template: ../tasks/MicroBuildCleanup.yml
...